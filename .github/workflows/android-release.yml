name: Android Release Build

# Triggers:
#   - Automatically on push to the release branch (alongside the desktop release)
#   - Manually via workflow_dispatch (useful to re-run after desktop release is created)
#
# Required GitHub secrets:
#   ANDROID_KEYSTORE        — base64-encoded .jks keystore file
#                             Generate: keytool -genkey -v -keystore release.jks -alias key0 \
#                                         -keyalg RSA -keysize 2048 -validity 10000
#                             Encode:   base64 -w 0 release.jks
#   ANDROID_KEY_ALIAS       — key alias used above (e.g. "key0")
#   ANDROID_STORE_PASSWORD  — keystore password
#   ANDROID_KEY_PASSWORD    — key password (can be same as store password)
#   POSTHOG_API_KEY         — analytics key (same as desktop release)

on:
  push:
    branches:
      - release
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable + Android targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Install Android NDK r27
        run: |
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --install "ndk;27.0.12077973"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: Install frontend dependencies
        run: yarn install

      - name: Get version from package.json
        id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > "$RUNNER_TEMP/release.keystore"

      - name: Build release APK (arm64)
        env:
          NDK_HOME: ${{ env.NDK_HOME }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
        # Builds arm64-only — covers 95%+ of modern Android phones.
        # Remove --target aarch64 to build a universal APK for all ABIs (slower).
        run: yarn tauri android build --apk --target aarch64

      - name: Sign APK
        run: |
          UNSIGNED=$(find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" | head -1)
          echo "Found unsigned APK: $UNSIGNED"

          BUILD_TOOLS=$(ls "$ANDROID_SDK_ROOT/build-tools" | sort -V | tail -1)
          SIGNED="dota-keeper-${{ steps.version.outputs.VERSION }}-android.apk"

          "$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS/apksigner" sign \
            --ks "$RUNNER_TEMP/release.keystore" \
            --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            --ks-pass "pass:${{ secrets.ANDROID_STORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --out "$SIGNED" \
            "$UNSIGNED"

          echo "SIGNED_APK=$SIGNED" >> $GITHUB_ENV
          echo "Signed APK: $SIGNED"

      - name: Upload APK as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: dota-keeper-${{ steps.version.outputs.VERSION }}-android
          path: ${{ env.SIGNED_APK }}
          retention-days: 30

      - name: Attach APK to GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Uploads to the draft release created by the desktop release job.
        # Uses || true so the workflow doesn't fail if the release doesn't exist yet
        # (run workflow_dispatch manually once the release is published).
        run: |
          gh release upload "v${{ steps.version.outputs.VERSION }}" "${{ env.SIGNED_APK }}" --clobber || \
            echo "⚠️  Could not upload to release (may not exist yet). APK is available as a workflow artifact."

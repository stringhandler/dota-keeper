# Secrets and Configuration for Dota Keeper

## Tauri Autoupdate Setup

### 1. Generate Signing Keys

The autoupdate feature requires cryptographic signing to ensure update authenticity. You need to generate a public/private key pair.

#### Generate Keys

Run this command in your terminal:

```bash
yarn tauri signer generate
```

Or if using npm:

```bash
npm run tauri signer generate
```

This will output:
- A **private key** (keep this secret!)
- A **public key** (this goes in your config)

#### Store the Private Key

**IMPORTANT: Never commit the private key to version control!**

Store the private key in an environment variable:

**Windows (PowerShell):**
```powershell
$env:TAURI_SIGNING_PRIVATE_KEY="your-private-key-here"
```

**Windows (CMD):**
```cmd
set TAURI_SIGNING_PRIVATE_KEY=your-private-key-here
```

**Linux/Mac:**
```bash
export TAURI_SIGNING_PRIVATE_KEY="your-private-key-here"
```

**For CI/CD (GitHub Actions):**
Add a repository secret named `TAURI_SIGNING_PRIVATE_KEY` with your private key value (see below for detailed instructions).

#### Add Public Key to Configuration

The public key has already been added to [src-tauri/tauri.conf.json](src-tauri/tauri.conf.json). If you need to regenerate it, update the `pubkey` field in the config.

### 2. Sign Your Releases

When building a release, the private key must be available as an environment variable. The build process will automatically sign the update files.

```bash
# Ensure TAURI_SIGNING_PRIVATE_KEY is set
yarn tauri build
```

### 3. GitHub Actions Automated Release Process

The repository includes a GitHub Actions workflow that automatically:
1. Builds the app for all platforms (Windows, Linux, macOS x64, macOS ARM)
2. Signs the releases with your private key
3. Creates a GitHub release with all installers
4. **Automatically updates `meta/autoupdate/latest.json`** with signatures and download URLs
5. Commits the updated `latest.json` back to the `main` branch

**To trigger a release:**
1. Update version numbers in `package.json`, `src-tauri/Cargo.toml`, and `src-tauri/tauri.conf.json`
2. Commit your changes
3. Push to the `release` branch:
   ```bash
   git push origin main:release
   ```
4. The workflow will automatically build, sign, and create the release
5. The `latest.json` will be automatically updated on the `main` branch

## GitHub Repository Secrets

To use the automated GitHub Actions workflow, you must add the signing key to your repository secrets:

### Required Secrets

1. **TAURI_SIGNING_PRIVATE_KEY** ⚠️ **CRITICAL - MUST BE SET**
   - Description: The private key generated by `yarn tauri signer generate`
   - Used for: Signing release builds to ensure authenticity
   - Location: Repository Settings > Secrets and variables > Actions
   - **Without this secret, the release workflow will fail**

2. **GITHUB_TOKEN** (automatically provided)
   - Description: Automatically provided by GitHub Actions
   - Used for: Publishing releases, uploading assets, and updating latest.json

### Optional Secrets

- **TAURI_KEY_PASSWORD**: If you password-protect your signing key (recommended for production)

### Setting Up the TAURI_SIGNING_PRIVATE_KEY Secret

1. Generate your signing key locally (if you haven't already):
   ```bash
   yarn tauri signer generate
   ```

2. Copy the **private key** from the output (it will look like a long base64 string starting with "dW50cnVzdGVkIGNvbW1lbnQ...")

3. Go to your GitHub repository:
   - Click "Settings" tab
   - Navigate to "Secrets and variables" > "Actions"
   - Click "New repository secret"
   - Name: `TAURI_SIGNING_PRIVATE_KEY`
   - Value: Paste your entire private key (including the "dW50cnVzdGVkIGNvbW1lbnQ..." prefix)
   - Click "Add secret"

4. The workflow will now automatically:
   - Sign all release builds
   - Extract signatures from the built installers
   - Update `latest.json` with the signatures and download URLs
   - Push the updated `latest.json` to the `main` branch

## Manual Update Process (If Not Using GitHub Actions)

If you're creating releases manually, you'll need to update `latest.json` yourself:

1. Build your app with signing: `yarn tauri build`
2. Find the `.sig` files in `src-tauri/target/release/bundle/` next to your installers
3. Create a GitHub release and upload the installers
4. Update `meta/autoupdate/latest.json` with:
   - New version number
   - Release notes
   - Publication date
   - Download URLs for each platform
   - Signatures from the `.sig` files
5. Commit and push the updated `latest.json` to the `main` branch

## Security Notes

- **Never commit private keys** to version control
- Add `TAURI_SIGNING_PRIVATE_KEY` to your `.gitignore` if storing locally
- Rotate signing keys periodically for enhanced security
- Use GitHub's encrypted secrets for CI/CD pipelines
- The public key in `tauri.conf.json` is safe to commit (it's public by design)
- The private key in GitHub Secrets is encrypted and only accessible during workflow runs

## Verification

To verify your setup:

1. Build your app with signing: `yarn tauri build`
2. Check that `.sig` files are generated alongside your installers
3. Ensure the public key in `tauri.conf.json` matches your private key
4. Test the update mechanism by deploying a test version
5. Or push to the `release` branch and verify the workflow completes successfully

## Troubleshooting

**Issue: "Invalid signature" error during update**
- Solution: Ensure the public key in `tauri.conf.json` matches the private key used to sign the release

**Issue: "Update check failed"**
- Solution: Verify the endpoint URL is correct and `latest.json` is accessible
- Check that `latest.json` is on the `main` branch and pushed to GitHub

**Issue: "No update available" when there should be**
- Solution: Verify version numbers, ensure `latest.json` has a higher version than your current app

**Issue: GitHub Actions workflow fails with "signing error"**
- Solution: Verify the `TAURI_SIGNING_PRIVATE_KEY` secret is set correctly in repository settings
- Make sure you copied the entire private key including any prefixes

**Issue: `latest.json` not updated after release**
- Solution: Check the `update-release-json` job in the GitHub Actions workflow
- Ensure the workflow has permissions to write to the repository
- Check that signatures were properly downloaded from the release

## How the Automated Workflow Works

1. **Build Stage**: When you push to the `release` branch, the workflow builds for all platforms
2. **Signing**: Each build is automatically signed using the `TAURI_SIGNING_PRIVATE_KEY` secret
3. **Release Creation**: A draft release is created with all installers and signatures
4. **Update JSON**: After all builds complete, a separate job:
   - Downloads the `.sig` signature files from the release
   - Reads the version from `package.json`
   - Generates the correct download URLs
   - Updates `meta/autoupdate/latest.json` with all information
   - Commits and pushes to the `main` branch
5. **Users Get Updates**: When users launch the app, it checks the `latest.json` URL and notifies them of updates

## Resources

- [Tauri Updater Plugin Documentation](https://v2.tauri.app/plugin/updater/)
- [Signing Guide](https://v2.tauri.app/plugin/updater/#signing-updates)
- [GitHub Actions Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)

# Fix Autoupdate Signatures

## Problem Statement
The `latest.json` file is being generated and uploaded to releases, but the signature fields are empty/not populated. This breaks the Tauri autoupdate functionality as it requires valid signatures to verify downloads.

## Current Status

### What's Working ✓
- `latest.json` is created successfully
- `latest.json` is uploaded to the GitHub release
- GitHub secrets (`TAURI_SIGNING_PRIVATE_KEY` and `TAURI_SIGNING_PRIVATE_KEY_PASSWORD`) are set
- Secrets are showing in GitHub Actions logs (environment variables are accessible)
- The workflow completes without errors

### What's Broken ✗
- Signature fields in `latest.json` are empty strings (`""`)
- `.sig` files are either:
  - Not being generated by the Tauri build process, OR
  - Not being uploaded to the GitHub release, OR
  - Generated with different filenames than expected

## Current Workflow Analysis

### Job 1: `release` (Lines 9-75)
```yaml
- uses: tauri-apps/tauri-action@v0
  env:
    TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
    TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
```
**Expected Behavior**: Should generate `.sig` files and upload them to the release
**Actual Behavior**: Unknown - need to verify if .sig files are actually created and uploaded

### Job 2: `update-release-json` (Lines 76-195)
```bash
gh release download "v${VERSION}" --pattern "*.sig" --dir ./signatures
```
**Expected Behavior**: Download all `.sig` files from the release
**Actual Behavior**: Downloads nothing (no .sig files found in release)

## Investigation Steps

### 1. Verify Signature Generation
- [ ] Check if `.sig` files are created locally during build
  - Current verification step (lines 70-74) runs `find src-tauri/target -name "*.sig"`
  - Review GitHub Actions logs to see if this finds any files
  - If no files found: Issue is with signature generation
  - If files found: Issue is with upload

### 2. Verify Signature Upload
- [ ] Check if tauri-action uploads `.sig` files to the release
  - Look at the GitHub release assets after the `release` job completes
  - Manually inspect what files were uploaded
  - If .sig files are missing: Issue is with tauri-action configuration

### 3. Check Tauri Configuration
- [ ] Review `tauri.conf.json` for updater configuration
  - Verify `updater.pubkey` is set correctly
  - Verify updater is enabled
  - Check if there are any signing-related settings

### 4. Verify Secret Format
- [ ] Ensure signing key is in correct format
  - Should be base64 encoded
  - Should be a valid Ed25519 key pair
  - Password should match the key

## Potential Root Causes

### Cause 1: tauri-action Not Uploading Signatures
**Symptom**: Signatures are generated locally but not uploaded to release
**Possible Reasons**:
- tauri-action version (v0) may have a bug
- `releaseDraft: true` might prevent signature upload
- Missing configuration parameter

**Solutions to Try**:
- [ ] Upgrade tauri-action to latest version (v0 → latest)
- [ ] Check tauri-action documentation for signature upload configuration
- [ ] Add explicit upload step after tauri-action completes
- [ ] Try `releaseDraft: false` to see if it affects signature upload

### Cause 2: Incorrect Signing Key Format
**Symptom**: Signatures fail to generate but no error is thrown
**Possible Reasons**:
- Key not base64 encoded correctly
- Key/password mismatch
- Corrupted key data

**Solutions to Try**:
- [ ] Regenerate signing keys using `tauri signer generate`
- [ ] Re-encode key as base64 and update GitHub secret
- [ ] Test signing locally before pushing to CI
- [ ] Add error checking in workflow to catch signing failures

### Cause 3: tauri.conf.json Missing Configuration
**Symptom**: Signing is silently skipped
**Possible Reasons**:
- Updater not properly configured
- Public key not set
- Updater disabled

**Solutions to Try**:
- [ ] Verify `updater.active` is `true`
- [ ] Verify `updater.pubkey` matches the private key
- [ ] Check if `bundle.updater` section exists

### Cause 4: Filename Mismatch
**Symptom**: Signatures are uploaded with different names than expected
**Possible Reasons**:
- Tauri generates different filename patterns
- Version-specific naming
- Platform-specific naming differences

**Solutions to Try**:
- [ ] List all files in the release to see actual .sig filenames
- [ ] Update the `find` patterns in `update-release-json` job (lines 121-154)
- [ ] Use `gh release view` to inspect actual asset names

### Cause 5: Tauri Action Not Creating Signatures Due to Version
**Symptom**: Using `tauri-action@v0` which may not support signing
**Possible Reasons**:
- v0 is very old and may not have signing support
- Signing feature may have been added in later versions

**Solutions to Try**:
- [ ] Update to `tauri-apps/tauri-action@v0.5` or later
- [ ] Check tauri-action changelog for signing feature availability

## Recommended Fix Strategy

### Phase 1: Diagnosis (High Priority)
1. [ ] Check the "Verify signature files were created" step in GitHub Actions logs
   - If no .sig files found: Focus on signature generation
   - If .sig files found: Focus on upload mechanism

2. [ ] Manually inspect the draft release assets
   - Download the release and list all files
   - Check if .sig files are present with different names

3. [ ] Review tauri.conf.json
   - Ensure updater configuration is correct
   - Verify public key is set

### Phase 2: Quick Wins (Try These First)
1. [ ] Update tauri-action version
   ```yaml
   - uses: tauri-apps/tauri-action@v0.5  # or latest
   ```

2. [ ] Add explicit verification of signatures in release
   ```yaml
   - name: List release assets
     run: gh release view "v${VERSION}" --json assets
   ```

3. [ ] Verify tauri.conf.json has updater enabled
   ```json
   {
     "bundle": {
       "updater": {
         "active": true,
         "pubkey": "..."
       }
     }
   }
   ```

### Phase 3: Alternative Approaches
If tauri-action doesn't upload signatures:

1. [ ] Manually upload signature files after tauri-action
   ```yaml
   - name: Upload signatures
     run: |
       find src-tauri/target/release/bundle -name "*.sig" -exec \
         gh release upload "v${VERSION}" {} \;
   ```

2. [ ] Collect signatures from all matrix builds
   - Upload as artifacts in `release` job
   - Download in `update-release-json` job
   - Upload to release manually

3. [ ] Sign files in a separate step
   - Use `tauri signer sign` command directly
   - More control over the signing process

## Testing Plan

### Local Testing
1. [ ] Generate signing keys locally
   ```bash
   yarn tauri signer generate
   ```

2. [ ] Test signing locally
   ```bash
   yarn tauri build --config tauri.conf.json
   ```

3. [ ] Verify .sig files are created in `target/release/bundle/`

4. [ ] Verify .sig file format and content (should contain base64 signature)

### CI Testing
1. [ ] Create test release workflow
2. [ ] Run with debug logging enabled
3. [ ] Inspect all outputs and artifacts
4. [ ] Verify signature upload to draft release

## Files to Investigate

- [ ] `.github/workflows/release.yml` - Current workflow
- [ ] `tauri.conf.json` - Tauri configuration
- [ ] `src-tauri/Cargo.toml` - Tauri dependencies
- [ ] GitHub Actions logs - Recent release runs
- [ ] Draft release assets - What's actually uploaded

## Success Criteria

- [ ] `.sig` files are generated for all platforms (Windows, Linux, macOS x64, macOS ARM)
- [ ] `.sig` files are uploaded to GitHub release
- [ ] `.sig` files are successfully downloaded by `update-release-json` job
- [ ] `latest.json` contains valid signature strings (not empty)
- [ ] Tauri autoupdate can verify signatures successfully

## References

- Tauri Signing Documentation: https://tauri.app/v1/guides/distribution/sign-windows
- tauri-action GitHub: https://github.com/tauri-apps/tauri-action
- Tauri Updater Guide: https://tauri.app/v1/guides/distribution/updater

## Priority
**HIGH** - Blocks proper autoupdate functionality

## Status
- [ ] Diagnosis complete
- [ ] Root cause identified
- [ ] Fix implemented
- [ ] Testing completed
- [ ] Deployed and verified

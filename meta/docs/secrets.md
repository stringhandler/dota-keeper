# Secrets and Configuration for Dota Keeper

## Tauri Autoupdate Setup

### 1. Generate Signing Keys

The autoupdate feature requires cryptographic signing to ensure update authenticity. You need to generate a public/private key pair.

#### Generate Keys

Run this command in your terminal:

```bash
yarn tauri signer generate
```

Or if using npm:

```bash
npm run tauri signer generate
```

This will output:
- A **private key** (keep this secret!)
- A **public key** (this goes in your config)

#### Store the Private Key

**IMPORTANT: Never commit the private key to version control!**

Store the private key in an environment variable:

**Windows (PowerShell):**
```powershell
$env:TAURI_SIGNING_PRIVATE_KEY="your-private-key-here"
```

**Windows (CMD):**
```cmd
set TAURI_SIGNING_PRIVATE_KEY=your-private-key-here
```

**Linux/Mac:**
```bash
export TAURI_SIGNING_PRIVATE_KEY="your-private-key-here"
```

**For CI/CD (GitHub Actions):**
Add a repository secret named `TAURI_SIGNING_PRIVATE_KEY` with your private key value.

#### Add Public Key to Configuration

Update the `pubkey` field in [src-tauri/tauri.conf.json](src-tauri/tauri.conf.json):

```json
"plugins": {
  "updater": {
    "active": true,
    "endpoints": [
      "https://raw.githubusercontent.com/stringhandler/dota-goals/main/meta/autoupdate/latest.json"
    ],
    "dialog": true,
    "pubkey": "YOUR_PUBLIC_KEY_HERE"  // <-- Replace this with your public key
  }
}
```

### 2. Sign Your Releases

When building a release, the private key must be available as an environment variable. The build process will automatically sign the update files.

```bash
# Ensure TAURI_SIGNING_PRIVATE_KEY is set
yarn tauri build
```

### 3. Update the latest.json File

After each release, you need to:

1. Update [meta/autoupdate/latest.json](meta/autoupdate/latest.json) with:
   - New version number
   - Release notes
   - Publication date
   - Download URLs for each platform
   - Signatures for each platform (generated during build)

2. The signatures are automatically generated in the `src-tauri/target/release/bundle/` directory after building. Look for `.sig` files next to your installers.

3. Commit and push the updated `latest.json` to the `main` branch.

### 4. GitHub Release Setup

For the autoupdate to work:

1. Create a GitHub release with tag `v{VERSION}` (e.g., `v0.1.2`)
2. Upload the built installers to the release
3. Ensure the URLs in `latest.json` match the release asset URLs
4. The structure should be:
   ```
   https://github.com/stringhandler/dota-goals/releases/download/v{VERSION}/{FILENAME}
   ```

### Example Workflow

1. Update version in `package.json`, `src-tauri/Cargo.toml`, and `src-tauri/tauri.conf.json`
2. Build the app: `yarn tauri build` (with `TAURI_SIGNING_PRIVATE_KEY` set)
3. Create GitHub release and upload the installers
4. Update `meta/autoupdate/latest.json` with new version, URLs, and signatures
5. Commit and push to `main` branch
6. Users will automatically be notified of the update on next app launch

## GitHub Repository Secrets

If you're using GitHub Actions for automated builds, add these secrets to your repository:

### Required Secrets

1. **TAURI_SIGNING_PRIVATE_KEY**
   - Description: The private key generated by `yarn tauri signer generate`
   - Used for: Signing release builds to ensure authenticity
   - Location: Repository Settings > Secrets and variables > Actions

2. **GITHUB_TOKEN** (automatically provided)
   - Description: Automatically provided by GitHub Actions
   - Used for: Publishing releases and uploading assets

### Optional Secrets

- **TAURI_KEY_PASSWORD**: If you password-protect your signing key (recommended for production)

## Security Notes

- **Never commit private keys** to version control
- Add `TAURI_SIGNING_PRIVATE_KEY` to your `.gitignore` if storing locally
- Rotate signing keys periodically for enhanced security
- Use GitHub's encrypted secrets for CI/CD pipelines
- The public key in `tauri.conf.json` is safe to commit (it's public by design)

## Verification

To verify your setup:

1. Build your app with signing: `yarn tauri build`
2. Check that `.sig` files are generated alongside your installers
3. Ensure the public key in `tauri.conf.json` matches your private key
4. Test the update mechanism by deploying a test version

## Troubleshooting

**Issue: "Invalid signature" error during update**
- Solution: Ensure the public key in `tauri.conf.json` matches the private key used to sign the release

**Issue: "Update check failed"**
- Solution: Verify the endpoint URL is correct and `latest.json` is accessible
- Check that `latest.json` is on the `main` branch and pushed to GitHub

**Issue: "No update available" when there should be**
- Solution: Verify version numbers, ensure `latest.json` has a higher version than your current app

## Resources

- [Tauri Updater Plugin Documentation](https://v2.tauri.app/plugin/updater/)
- [Signing Guide](https://v2.tauri.app/plugin/updater/#signing-updates)
